name: Chrome Automation with Playwright and Ngrok

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  browser:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4      
      - name: Build Docker
        run: docker build . -t orbita-docker

      - name: Run Docker container
        env:
          SCREEN_WIDTH: 1920
          SCREEN_HEIGHT: 1080
          PROFILE_ID: 67eeb053a9cb6a7191579b8b
          TOKEN: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI2N2VlYWJmOGJkODY2YjdjM2Y2NmIzZjEiLCJ0eXBlIjoiZGV2Iiwiand0aWQiOiI2N2VlYWMyNjcwZTM0MDBhNWY2YjdkZmUifQ.tUvpgtJL0swAUinAx1XIeWt4OQMjBqszIciDPKoE9Nk
        run: |
          docker run \
            -e SCREEN_WIDTH=$SCREEN_WIDTH \
            -e SCREEN_HEIGHT=$SCREEN_HEIGHT \
            -e PROFILE_ID=$PROFILE_ID \
            -e TOKEN=$TOKEN \
            --rm \
            -p 3000:3000 \
            --name orbita-browser-${{ github.run_id }} \
            orbita-docker:latest
      
  server:
    needs: browser
    runs-on: ubuntu-latest
    steps:
      - name: Pull ngrok Docker image
        run: docker pull ngrok/ngrok:latest

      - name: Run ngrok in Docker container
        env:
          NGROK_AUTH_TOKEN: 2QbyRGbKo6nke3jchCvGzNLRVCx_5WdiY2dfgqmbnwBUU3Bzv
        run: |
          # Run ngrok in Docker container
          docker run -d \
            --name ngrok-container \
            -e NGROK_AUTHTOKEN=$NGROK_AUTH_TOKEN \
            -p 4040:4040 \
            ngrok/ngrok:latest http host.docker.internal:3000
          
          # Wait for ngrok to start
          sleep 10
          
          # Get the URL directly
          docker exec ngrok-container wget -q -O- http://localhost:4040/api/tunnels > ngrok_info.json
          
          # Simple extraction using grep
          grep -o "https://[a-zA-Z0-9.-]*\.ngrok\.io" ngrok_info.json | head -n1 > ngrok_url.txt
          
          echo "========== noVNC ACCESS =========="
          echo "Open this URL in your browser:"
          cat ngrok_url.txt
          echo "=================================="
          
          # Keep the workflow running
          docker logs -f ngrok-container


