name: Chrome Automation with Playwright and Ngrok

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  automation:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install ngrok
        run: |
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update && sudo apt install ngrok

      - name: Build Docker
        run: docker build . -t orbita-docker

      - name: Run Docker container
        env:
          SCREEN_WIDTH: 1920
          SCREEN_HEIGHT: 1080
          PROFILE_ID: 67eeb053a9cb6a7191579b8b
          TOKEN: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI2N2VlYWJmOGJkODY2YjdjM2Y2NmIzZjEiLCJ0eXBlIjoiZGV2Iiwiand0aWQiOiI2N2VlYWMyNjcwZTM0MDBhNWY2YjdkZmUifQ.tUvpgtJL0swAUinAx1XIeWt4OQMjBqszIciDPKoE9Nk
        run: docker run -e SCREEN_WIDTH=$SCREEN_WIDTH -e SCREEN_HEIGHT=$SCREEN_HEIGHT -e PROFILE_ID=$PROFILE_ID -e TOKEN=$TOKEN --rm -ti -p 5901:5901 -p 3000:3000  --name orbita-browser orbita-docker:latest 
      
      - name: Start ngrok tunnel for VNC
        env:
          NGROK_AUTH_TOKEN: 2QbyRGbKo6nke3jchCvGzNLRVCx_5WdiY2dfgqmbnwBUU3Bzv
        run: |
          ngrok authtoken $NGROK_AUTH_TOKEN
          ngrok http 3000 --log=stdout > ngrok.log &
          
          sleep 10

          echo "Extracting ngrok public URL..."
          grep -o "url=https://[0-9a-zA-Z.-]*" ngrok.log | tail -n1 | cut -d'=' -f2 | tee ngrok_url.txt

          echo "========== noVNC ACCESS =========="
          echo "Open this URL in your browser:"
          cat ngrok_url.txt
          echo "=================================="
        
          # Giữ cho workflow chạy một thời gian để bạn có thể kết nối
          tail -f ngrok.log



