name: Chrome Automation with Playwright and Ngrok

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  browser:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4      
      - name: Install Anti
        env:
          SCREEN_WIDTH: 1920
          SCREEN_HEIGHT: 1080
          PROFILE_ID: 67eeb053a9cb6a7191579b8b
          TOKEN: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI2N2VlYWJmOGJkODY2YjdjM2Y2NmIzZjEiLCJ0eXBlIjoiZGV2Iiwiand0aWQiOiI2N2VlYWMyNjcwZTM0MDBhNWY2YjdkZmUifQ.tUvpgtJL0swAUinAx1XIeWt4OQMjBqszIciDPKoE9Nk
        run: |
          docker run \
            -e SCREEN_WIDTH=$SCREEN_WIDTH \
            -e SCREEN_HEIGHT=$SCREEN_HEIGHT \
            -e PROFILE_ID=$PROFILE_ID \
            -e TOKEN=$TOKEN \
            --rm \
            -p 80:80 \
            -p 9000:80 \
            -p 5901:5901 \
            -p 3500:3500 \
            -v $(pwd):/app \
            -v $(pwd)/entrypoint.sh:/entrypoint.sh \
            -v $(pwd)/.docker/app.conf:/etc/nginx/conf.d/app.conf \
            --name anti \
            minhvh/anti:latest

      - name: Install Ngrok
        run: |
          resp=$(curl https://127.0.0.1:9000/api/ping)
          echo "Response: $resp"

      - name: Install Ngrok
        env:
          NGROK_AUTH_TOKEN: 2QbyRGbKo6nke3jchCvGzNLRVCx_5WdiY2dfgqmbnwBUU3Bzv
        run: |
          curl -sLO https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-stable-linux-amd64.zip
          unzip ngrok-stable-linux-amd64.zip
          sudo mv ngrok /usr/local/bin
          ngrok config add-authtoken $NGROK_AUTH_TOKEN
          
          # Configure ngrok
          ngrok config add-authtoken $NGROK_AUTH_TOKEN
          
          # Start ngrok tunnels in background
          ngrok http 9000 --log=ngrok_http.log &
          ngrok tcp 5901 --log=ngrok_tcp.log &
    
          sleep 5

          HTTP_URL=$(grep -o 'https://[^ ]*' ngrok_http.log | head -n 1)
          VNC_URL=$(grep -o 'tcp://[^ ]*' ngrok_tcp.log | head -n 1)
          
          echo "HTTP URL: $HTTP_URL"
          echo "VNC URL: $VNC_URL"

      - name: Keep alive
        run: sleep 300




