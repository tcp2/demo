name: Chrome Automation with Playwright and Ngrok

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  automation:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v3
        with:
          node-version: "20"
      
      # Tải và cài đặt ngrok trước
      - name: Setup ngrok
        env:
          NGROK_AUTH_TOKEN: 2QbyRGbKo6nke3jchCvGzNLRVCx_5WdiY2dfgqmbnwBUU3Bzv
        run: |
          wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
          tar -xzf ngrok-v3-stable-linux-amd64.tgz
          chmod +x ./ngrok
          ./ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
      
      - name: Run Playwright in devcontainer
        uses: devcontainers/ci@v0.3
        with:
          runCmd: |
            # Cài đặt dependencies
            npm ci
            
            # Chạy test với Playwright với VNC được bật
            npm test &
            
            # Đợi VNC server khởi động
            sleep 10
            
            # Hiển thị thông tin về container
            echo "Browser container is running on port 6080 (VNC)"
            
            # Giữ container chạy để có thể kết nối từ xa
            # Không kết thúc job ở đây, sẽ được kiểm soát bởi bước chạy ngrok sau
      
      - name: Start ngrok tunnel
        run: |
          # Chạy ngrok để tạo tunnel đến port 6080 (VNC port)
          ./ngrok http 6080 --log=stdout > ngrok.log &
          sleep 5
          NGROK_URL=$(grep -o 'https://.*\.ngrok\.io\|https://.*\.ngrok-free\.app' ngrok.log | head -n 1)
          echo "Ngrok URL: $NGROK_URL"
          
          # Hiển thị URL cho người dùng
          echo "Trình duyệt có thể truy cập tại: $NGROK_URL"
          
          # Giữ ngrok và workflow chạy trong một khoảng thời gian
          sleep 3600
